<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Smart City Tour con OpenAI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --bubble-user:#3b82f6; --bubble-bot:#0b1222;
      --text:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --border:#1f2937;
      --ui-font-size:12.5px; --bubble-font-size:12.5px; --small-font-size:11.5px;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f1f5f9; --panel:#fff; --bubble-user:#2563eb; --bubble-bot:#f3f4f6;
        --text:#0f172a; --muted:#475569; --accent:#16a34a; --border:#e5e7eb; }
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(34,197,94,.15), transparent 60%),
        radial-gradient(900px 600px at 120% 0%, rgba(59,130,246,.12), transparent 50%),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif;
      line-height:1.35;
      font-size:var(--ui-font-size);
    }
    .shell{ max-width:980px; margin:0 auto; padding:24px; display:grid; grid-template-rows:auto 1fr; gap:16px; height:100dvh; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px 14px; border:1px solid var(--border); background:var(--panel); border-radius:14px; }
    .brand{ display:flex; align-items:center; gap:12px; }
    .badge,.today{ font-size:12px; color:var(--muted); }

    main{ display:grid; gap:12px; }
    .toolbar{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; padding:8px; border:1px solid var(--border); background:var(--panel); border-radius:12px; }
    .chip{ border:1px solid var(--border); background:transparent; color:var(--text); padding:6px 10px; border-radius:999px; cursor:pointer; font-size:13px; }
    .chip:hover{ border-color:var(--muted); }
    .toggle{ display:inline-flex; align-items:center; gap:8px; font-size:13px; color:var(--muted); }
    .select{ background:transparent; color:var(--text); border:1px solid var(--border); border-radius:8px; padding:6px 8px; font-size:12px; }

    #chatbox{ border:1px solid var(--border); background:var(--panel); border-radius:16px; padding:12px; display:grid; grid-template-rows:1fr auto; min-height:0; }
    #chatlog{ overflow-y:auto; padding:8px; min-height:280px; max-height:64vh; scroll-behavior:smooth; }
    .row{ display:flex; margin:10px 0; gap:10px; }
    .row.user{ justify-content:flex-end; }
    .bubble{ max-width:min(78%, 720px); padding:10px 12px; border-radius:14px; border:1px solid var(--border); white-space:pre-wrap; overflow-wrap:anywhere; }
    .user .bubble{ background:var(--bubble-user); color:#fff; border-color:transparent; }
    .bot .bubble{ background:var(--bubble-bot); }

    .meta{ font-size:11px; color:var(--muted); margin-top:4px; }
    .bubble h1,.bubble h2,.bubble h3{ margin:.4em 0 .2em; }
    .bubble p{ margin:.4em 0; }
    .bubble ul{ margin:.4em 0 .4em 1.1em; }
    .bubble li{ margin:.25em 0; }
    .bubble code{ padding:2px 4px; border-radius:6px; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:.95em; background:rgba(148,163,184,.2); }
    .bubble pre{ padding:10px; border-radius:8px; overflow:auto; background:rgba(148,163,184,.15); border:1px dashed var(--border); }
    .bubble a{ color:#93c5fd; text-decoration:underline; }

    form#composer{ display:grid; grid-template-columns:1fr auto; gap:8px; padding:8px; border-top:1px dashed var(--border); }
    textarea{
      resize:none; min-height:44px; max-height:160px; padding:10px 12px; border-radius:12px;
      background:transparent; color:var(--text); border:1px solid var(--border); outline:none;
    }
    textarea:focus{ border-color:var(--muted); }
    button.send{ padding:10px 16px; border-radius:12px; border:none; cursor:pointer; background:linear-gradient(135deg,var(--accent),#10b981); color:#052e16; font-weight:700; }
    button.send[disabled]{ opacity:.6; cursor:not-allowed; }

    .actions{ display:flex; gap:8px; margin-left:auto; }
    .ghost{ padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text); cursor:pointer; font-size:13px; }
    .ghost:hover{ border-color:var(--muted); }
    .cta{ padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text); cursor:pointer; font-size:13px; }
    .cta.primary{ border-color:transparent; background:linear-gradient(135deg,var(--accent),#10b981); color:#052e16; font-weight:700; }
    .cta[disabled]{ opacity:.6; cursor:not-allowed; }
  </style>
</head>
<body>
  <div class="shell">
    <header role="banner">
      <div class="brand">
        <div>
          <strong>Smart City Tour</strong>
          <div class="badge" id="geo-status">Ubicación: desconocida</div>
        </div>
      </div>
      <div class="today" id="today" aria-live="polite"></div>
    </header>

    <main role="main" aria-label="Asistente de viaje">
      <div class="toolbar" role="toolbar" aria-label="Opciones">
        <!-- Chips principales -->
        <button type="button" class="chip" data-q="Museos" aria-label="Buscar Museos">Museos</button>
        <button type="button" class="chip" data-q="Teatros" aria-label="Buscar Teatros">Teatros</button>
        <button type="button" class="chip" data-q="Parques" aria-label="Buscar Parques">Parques</button>
        <button type="button" class="chip" data-q="Bares" aria-label="Buscar Bares">Bares</button>
        <button type="button" class="chip" data-q="Cafés" aria-label="Buscar Cafés">Cafés</button>
        <button type="button" class="chip" data-q="Restaurantes" aria-label="Buscar Restaurantes">Restaurantes</button>

        <!-- Filtros -->
        <label class="toggle"><input type="checkbox" id="use-geo" /> Usar mi ubicación</label>
        <label class="toggle"><input type="checkbox" id="prefer-open" /> Abiertos ahora</label>
        <label class="toggle"><input type="checkbox" id="wheelchair" /> Accesible</label>
        <label class="toggle"><input type="checkbox" id="reservas" /> Admite reservas</label>

        <!-- Inicio -->
        <label class="toggle" for="start-time">Inicio
          <input type="time" id="start-time" value="09:30" class="select" />
        </label>

        <div class="actions">
          <button type="button" class="ghost" id="clear" aria-label="Limpiar conversación">Limpiar</button>
          <button type="button" class="ghost" id="export" aria-label="Exportar conversación">Exportar</button>
          <button type="button" class="cta" id="show-on-map" aria-label="Ver en mapa" disabled>Ver en mapa</button>
        </div>
      </div>

      <div id="chatbox" aria-label="Chat">
        <div id="chatlog" role="log" aria-live="polite" aria-atomic="false"></div>

        <form id="composer" novalidate>
          <textarea id="user-input" placeholder="Escribe tu mensaje... (Shift+Enter para nueva línea)" required aria-label="Mensaje" autocomplete="off" autocapitalize="sentences" autofocus></textarea>
          <button type="submit" class="send" id="send" aria-label="Enviar mensaje">Enviar</button>
        </form>
      </div>
    </main>
  </div>

  <script>
    // ===== helpers DOM =====
    const $  = (q, node=document) => node.querySelector(q);
    const $$ = (q, node=document) => [...node.querySelectorAll(q)];

    const chatlog     = $("#chatlog");
    const input       = $("#user-input");
    const sendBtn     = $("#send");
    const preferOpen  = $("#prefer-open");
    const startTimeEl = $("#start-time");
    const todayBox    = $("#today");
    const geoStatus   = $("#geo-status");
    const wheelchair  = $("#wheelchair");
    const reservas    = $("#reservas");
    const showOnMapBtn = $("#show-on-map");
    const useGeo      = $("#use-geo");
    const clearBtn    = $("#clear");
    const exportBtn   = $("#export");

    // ===== conversation_id persistente =====
    function uuid(){ return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
      (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
    );}
    let conversationId = localStorage.getItem("conversation_id");
    if (!conversationId) {
      conversationId = uuid();
      localStorage.setItem("conversation_id", conversationId);
    }

    // ===== fecha/hora cabecera =====
    function setToday(){
      const d = new Date();
      const fmt = new Intl.DateTimeFormat("es-ES",{ dateStyle:"full", timeStyle:"short" });
      todayBox.textContent = fmt.format(d);
    }
    setToday(); setInterval(setToday, 60_000);

    // ===== almacenamiento =====
    const MAX_HISTORY = 24;
    let chatHistory = [];
    try { chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]"); } catch { chatHistory = []; }

    function saveHistory(){
      if (chatHistory.length > MAX_HISTORY) chatHistory = chatHistory.slice(-MAX_HISTORY);
      localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
    }

    // preferencias simples (solo filtros y hora de inicio)
    const prefs = JSON.parse(localStorage.getItem("uiPrefs") || "{}");
    ["use-geo","prefer-open","wheelchair","reservas"].forEach(id=>{
      if (id in prefs) $(`#${id}`).checked = !!prefs[id];
      $(`#${id}`).addEventListener("change", ()=>{
        prefs[id] = $(`#${id}`).checked;
        localStorage.setItem("uiPrefs", JSON.stringify(prefs));
      });
    });
    if (prefs.startTime) startTimeEl.value = prefs.startTime;
    startTimeEl.addEventListener("change", ()=>{
      prefs.startTime = startTimeEl.value;
      localStorage.setItem("uiPrefs", JSON.stringify(prefs));
    });

    // ===== Estado de chat activo/inactivo =====
    function setChatEnabled(enabled){
      input.disabled = !enabled;
      sendBtn.disabled = !enabled;
      $$(".chip").forEach(el => el.disabled = !enabled);
      [useGeo, preferOpen, wheelchair, reservas, startTimeEl].forEach(el => el.disabled = !enabled);
      clearBtn.disabled = !enabled;
      exportBtn.disabled = !enabled;
      // Botón mapa: si hay petición en curso, desactivar; si termina, lo maneja refreshShowOnMapState()
      showOnMapBtn.disabled = true;
      showOnMapBtn.setAttribute("aria-disabled", "true");
    }
    function setBusy(isBusy){
      const box = $("#chatbox");
      if (isBusy){
        setChatEnabled(false);
        box.setAttribute("aria-busy","true");
      } else {
        setChatEnabled(true);
        box.removeAttribute("aria-busy");
        // Tras habilitar, sincronizamos estado del mapa según place_ids
        refreshShowOnMapState();
      }
    }

    // ===== restaurar historial o pedir primer mensaje al backend =====
    if (chatHistory.length > 0){
      chatHistory.forEach(m => addRow(m.role === "assistant" ? "assistant" : m.role, m.content, false));
      scrollBottom();
    } else {
      bootstrapFirstMessage();
    }

    async function bootstrapFirstMessage(){
      const payload = {
        conversation_id: conversationId,
        messages: [{ role: "user", content: "inicio" }],
        prefer_open: preferOpen.checked,
        bootstrap: true
      };
      if (useGeo.checked && userLat != null && userLon != null){
        payload.start_lat = userLat;
        payload.start_lon = userLon;
      }
      setBusy(true);
      await callChat(payload);
      // setBusy(false) se llama dentro de callChat finally
    }

    // ===== markdown muy ligero =====
    function escapeHtml(s){ return s.replace(/[<>&]/g, ch => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[ch])); }
    function mdToHtml(md){
      md = escapeHtml(md);
      md = md.replace(/```([\s\S]*?)```/g, (m,p1)=>`<pre><code>${p1}</code></pre>`);
      md = md.replace(/`([^`]+)`/g, '<code>$1</code>');
      md = md.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      md = md.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      const lines = md.split(/\n/);
      let out = [], inList = false;
      for (const line of lines){
        const m = line.match(/^\s*[-•]\s+(.*)$/);
        if (m){
          if (!inList){ out.push("<ul>"); inList = true; }
          out.push(`<li>${m[1]}</li>`);
        } else {
          if (inList){ out.push("</ul>"); inList = false; }
          out.push(line);
        }
      }
      if (inList) out.push("</ul>");
      md = out.join("\n");
      md = md.replace(/(https?:\/\/[^\s)]+)(?![^<]*>)/g, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
      md = md.replace(/\n{2,}/g, '\n\n').replace(/\n/g, '<br>');
      return md;
    }

    function addRow(role, text, withTime=true){
      const row = document.createElement("div");
      row.className = `row ${role === "assistant" ? "bot" : role}`;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = role === "assistant" ? mdToHtml(text) : escapeHtml(text);
      row.appendChild(bubble);

      if (withTime){
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = new Intl.DateTimeFormat("es-ES",{ hour:"2-digit", minute:"2-digit" }).format(new Date());
        bubble.appendChild(document.createElement("br"));
        bubble.appendChild(meta);
      }
      chatlog.appendChild(row);
    }
    function addUser(text){ addRow("user", text); }
    function addBot(text){ addRow("assistant", text); }
    function scrollBottom(){ chatlog.scrollTop = chatlog.scrollHeight; }

    // ===== chips =====
    $$(".chip").forEach(b => b.addEventListener("click", ()=>{
      input.value = b.dataset.q || "";
      input.focus();
    }));

    // ===== limpiar / exportar =====
    $("#clear").addEventListener("click", async ()=>{
      chatHistory = [];
      localStorage.removeItem("chatHistory");
      chatlog.innerHTML = "";

      ["use-geo","prefer-open","wheelchair","reservas"].forEach(id => { $(`#${id}`).checked = false; });
      startTimeEl.value = "09:30";
      localStorage.removeItem("uiPrefs");

      // reset de conversación
      conversationId = uuid();
      localStorage.setItem("conversation_id", conversationId);

      addBot("Conversación reiniciada. Generando una vista general…");
      chatHistory.push({ role:"assistant", content:"Conversación reiniciada. Generando una vista general…" });
      saveHistory();

      setBusy(true);
      await bootstrapFirstMessage();
    });

    $("#export").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(chatHistory, null, 2)], { type:"application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `smart-city-tour_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(a.href);
      a.remove();
    });

    // ===== intención & filtros por texto (backend decide plan por texto) =====
    const INTENT = {
      near: /\b(cerca|alrededor|por\s?aqu[ií]|a mi alrededor|cercan[oa]s)\b/i,
    };
    const FILTERS_RX = {
      open: /\babiert[oa]s?\s+ahora\b/i,
      accessible: /\baccesible\b|\bsilla\s+de\s+ruedas\b/i,
      booking: /\breserva(s|r)?\b|\bbooking\b|\bbook\b/i,
    };
    function applyFiltersFromText(raw){
      const text = (raw || "");
      if (FILTERS_RX.open.test(text))  $("#prefer-open").checked = true;
      if (FILTERS_RX.accessible.test(text)) $("#wheelchair").checked = true;
      if (FILTERS_RX.booking.test(text)) $("#reservas").checked = true;
      return { near: INTENT.near.test(text) };
    }
    function buildFilterSuffix() {
      const parts = [];
      if (preferOpen.checked) parts.push("abiertos ahora");
      if (wheelchair.checked) parts.push("accesible silla de ruedas");
      if (reservas.checked) parts.push("reserva");
      return parts.join(" ").trim();
    }

    // ===== geolocalización =====
    let userLat = null, userLon = null;
    function requestGeo(){
      if (!navigator.geolocation){
        geoStatus.textContent = "Ubicación: no soportada";
        return Promise.resolve(false);
      }
      geoStatus.textContent = "Ubicación: solicitando permiso…";
      return new Promise(resolve => {
        navigator.geolocation.getCurrentPosition(
          (pos)=>{
            userLat = +(pos.coords.latitude.toFixed(6));
            userLon = +(pos.coords.longitude.toFixed(6));
            geoStatus.textContent = `Ubicación: ✓ (${userLat}, ${userLon})`;
            resolve(true);
          },
          (err)=>{
            geoStatus.textContent = "Ubicación: denegada o no disponible";
            userLat = userLon = null;
            console.warn("Geolocation error:", err);
            resolve(false);
          },
          { enableHighAccuracy:true, timeout:10000, maximumAge:300000 }
        );
      });
    }
    $("#use-geo").addEventListener("change", async (e)=>{
      if (e.target.checked) await requestGeo();
      else { userLat = userLon = null; geoStatus.textContent = "Ubicación: desactivada"; }
    });

    async function ensureGeolocationIfNeeded(wantsNear) {
      if (!wantsNear) return true;
      if (useGeo.checked && userLat != null && userLon != null) return true;

      addBot("Puedo buscar **cerca de ti**. Activa “Usar mi ubicación” y acepta el permiso, luego reenvía tu mensaje. ¿Quieres activarlo ahora?");
      const ok = confirm("Para buscar cerca de ti, necesito tu ubicación. ¿Activarla ahora?");
      if (!ok) return false;

      useGeo.checked = true;
      const ok2 = await requestGeo();
      return ok2 && userLat != null && userLon != null;
    }

    // ===== “pensando…” animado =====
    function startDots(rowEl){
      const span = rowEl.querySelector(".thinking");
      if (!span) return;
      let i = 0;
      const id = setInterval(()=>{ span.textContent = ".".repeat(1 + (i++ % 3)); }, 400);
      rowEl.dataset.dotsTimer = String(id);
    }
    function stopDots(rowEl){
      const id = rowEl?.dataset?.dotsTimer;
      if (id){ clearInterval(Number(id)); delete rowEl.dataset.dotsTimer; }
    }

    // ===== petición al backend =====
    async function callChat(payload){
      payload.conversation_id = conversationId;

      const box = $("#chatbox");
      const thinking = document.createElement("div");
      thinking.className = "row bot";
      thinking.innerHTML = `<div class="bubble">Pensando<span class="thinking">.</span></div>`;
      chatlog.appendChild(thinking);
      startDots(thinking);
      scrollBottom();
      // ya está setBusy(true) antes de llamar a callChat; si no, lo ponemos:
      box.setAttribute("aria-busy","true");

      try{
        const controller = new AbortController();
        const timeout = setTimeout(()=>controller.abort(), 45000);

        const res = await fetch("/chat", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        clearTimeout(timeout);

        const lastBubble = thinking.querySelector(".bubble");
        stopDots(thinking);

        if (!res.ok){
          lastBubble.textContent = `❌ Error ${res.status}: no se pudo obtener respuesta.`;
          return;
        }
        const data = await res.json();
        if (data && data.response){
          lastBubble.innerHTML = mdToHtml(data.response);
          chatHistory.push({ role:"assistant", content: data.response });
          saveHistory();
        } else {
          lastBubble.textContent = "❌ Respuesta vacía del servidor.";
        }
      } catch(err){
        const lastBubble = thinking.querySelector(".bubble");
        stopDots(thinking);
        if (lastBubble) lastBubble.textContent = "❌ Error al contactar con el servidor.";
        console.error(err);
      } finally {
        // terminar estado ocupado SIEMPRE aquí
        setBusy(false);
        scrollBottom();
      }
    }

    // ===== envío normal =====
    $("#composer").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const raw = input.value.trim();
      if (!raw) return;

      // aplicar filtros sugeridos por el texto
      const { near } = applyFiltersFromText(raw);
      const canProceed = await ensureGeolocationIfNeeded(near);
      if (!canProceed) return;

      const filtersSuffix = buildFilterSuffix();
      const finalText = filtersSuffix ? `${raw} ${filtersSuffix}` : raw;

      chatHistory.push({ role:"user", content: finalText });
      saveHistory();
      addUser(raw + (filtersSuffix ? `  ·  filtros: ${filtersSuffix}` : ""));
      input.value = "";
      input.style.height = "auto";

      const payload = {
        conversation_id: conversationId,
        messages: chatHistory,
        start_time: startTimeEl.value || "09:30",
        prefer_open: preferOpen.checked
      };
      if (useGeo.checked && userLat != null && userLon != null){
        payload.start_lat = userLat;
        payload.start_lon = userLon;
      }

      // Desactivar chat mientras esperamos la respuesta
      setBusy(true);
      await callChat(payload);
      // setBusy(false) se ejecuta en finally de callChat
    });

    // textarea auto-grow + Enter para enviar
    input.addEventListener("input", ()=>{
      input.style.height = "auto";
      input.style.height = Math.min(input.scrollHeight, 160) + "px";
    });
    input.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        $("#composer").requestSubmit();
      }
    });

    // ===== Ver en mapa =====
    showOnMapBtn.addEventListener("click", () => {
      try {
        window.parent?.postMessage({ type: "SCT_SHOW_ON_MAP", conversation_id: conversationId }, "*");
      } catch (e) { console.warn(e); }
    });

    async function refreshShowOnMapState() {
      try {
        let hasAny = false;
        if (conversationId) {
          const r1 = await fetch(`/api/conversation_place_ids/${encodeURIComponent(conversationId)}`);
          if (r1.ok) {
            const j1 = await r1.json();
            hasAny = Array.isArray(j1.place_ids) && j1.place_ids.length > 0;
          }
        }
        if (!hasAny) {
          const r2 = await fetch(`/api/current_place_ids`);
          if (r2.ok) {
            const j2 = await r2.json();
            hasAny = Array.isArray(j2.place_ids) && j2.place_ids.length > 0;
          }
        }
        showOnMapBtn.disabled = !hasAny;
        showOnMapBtn.setAttribute("aria-disabled", String(!hasAny));
        showOnMapBtn.title = hasAny ? "Ver en mapa" : "No hay resultados que mostrar";
      } catch {}
    }

    window.addEventListener("load", ()=>{
      refreshShowOnMapState();
      if (useGeo.checked) requestGeo();
    });
  </script>
</body>
</html>
